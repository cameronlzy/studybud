{% extends "base.html" %} 
{% block content %}
{% load static %}
    <main class="profile-page layout layout--2">
      <div class="container">
        <!-- Room Start -->
        <div class="room">
          <div class="room__top">
            <div class="room__topLeft">
              <a href="{% url 'home' %}">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                  <title>arrow-left</title>
                  <path
                    d="M13.723 2.286l-13.723 13.714 13.719 13.714 1.616-1.611-10.96-10.96h27.625v-2.286h-27.625l10.965-10.965-1.616-1.607z"
                  ></path>
                </svg>
              </a>
              <h3>Study Room</h3>
            </div>
            {% if room.host == request.user %}
            <div class="room__topRight">
              <a href="{% url 'update-room' room.id %}">
                <svg
                  enable-background="new 0 0 24 24"
                  height="32"
                  viewBox="0 0 24 24"
                  width="32"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <title>edit</title>
                  <g>
                    <path d="m23.5 22h-15c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h15c.276 0 .5.224.5.5s-.224.5-.5.5z" />
                  </g>
                  <g>
                    <g>
                      <path
                        d="m2.5 22c-.131 0-.259-.052-.354-.146-.123-.123-.173-.3-.133-.468l1.09-4.625c.021-.09.067-.173.133-.239l14.143-14.143c.565-.566 1.554-.566 2.121 0l2.121 2.121c.283.283.439.66.439 1.061s-.156.778-.439 1.061l-14.142 14.141c-.065.066-.148.112-.239.133l-4.625 1.09c-.038.01-.077.014-.115.014zm1.544-4.873-.872 3.7 3.7-.872 14.042-14.041c.095-.095.146-.22.146-.354 0-.133-.052-.259-.146-.354l-2.121-2.121c-.19-.189-.518-.189-.707 0zm3.081 3.283h.01z"
                      />
                    </g>
                    <g>
                      <path
                        d="m17.889 10.146c-.128 0-.256-.049-.354-.146l-3.535-3.536c-.195-.195-.195-.512 0-.707s.512-.195.707 0l3.536 3.536c.195.195.195.512 0 .707-.098.098-.226.146-.354.146z"
                      />
                    </g>
                  </g>
                </svg>
              </a>
              <a href="{% url 'delete-room' room.id %}">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                  <title>remove</title>
                  <path
                    d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z"
                  ></path>
                </svg>
              </a>
            </div>
            {% endif %}

            <!-- <button class="action-button" data-id="120" data-delete-url="https://randomuser.me/api/3324923"
            data-edit-url="profile.html">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <title>ellipsis-horizontal</title>
              <path
                d="M16 7.843c-2.156 0-3.908-1.753-3.908-3.908s1.753-3.908 3.908-3.908c2.156 0 3.908 1.753 3.908 3.908s-1.753 3.908-3.908 3.908zM16 1.98c-1.077 0-1.954 0.877-1.954 1.954s0.877 1.954 1.954 1.954c1.077 0 1.954-0.877 1.954-1.954s-0.877-1.954-1.954-1.954z">
              </path>
              <path
                d="M16 19.908c-2.156 0-3.908-1.753-3.908-3.908s1.753-3.908 3.908-3.908c2.156 0 3.908 1.753 3.908 3.908s-1.753 3.908-3.908 3.908zM16 14.046c-1.077 0-1.954 0.877-1.954 1.954s0.877 1.954 1.954 1.954c1.077 0 1.954-0.877 1.954-1.954s-0.877-1.954-1.954-1.954z">
              </path>
              <path
                d="M16 31.974c-2.156 0-3.908-1.753-3.908-3.908s1.753-3.908 3.908-3.908c2.156 0 3.908 1.753 3.908 3.908s-1.753 3.908-3.908 3.908zM16 26.111c-1.077 0-1.954 0.877-1.954 1.954s0.877 1.954 1.954 1.954c1.077 0 1.954-0.877 1.954-1.954s-0.877-1.954-1.954-1.954z">
              </path>
            </svg>
          </button> -->
          </div>
          <div class="room__box scroll">
            <div class="room__header scroll">
              <div class="room__info">
                <h3>{{room.name}}</h3>
                <span>{{room.created|timesince}}</span>
              </div>
              <div class="room__hosted">
                <p>Hosted By</p>
                <a href="{% url 'user-profile' room.host.id %}" class="room__author">
                  <div class="avatar avatar--small" data-user-id="{{ room.host.id }}">
                    {% if room.host.profile.profile_img %}
                      <img src="{{ room.host.profile.profile_img.url }}" alt="Profile" />
                    {% else %}
                      <img src="{% static 'images/avatar.svg' %}" alt="Profile" />
                    {% endif %}
                  </div>
                  <span>@{{room.host.username}}</span>
                </a>
              </div>
              <!-- <div class="room__details">
                Lorem ipsum dolor sit, amet consectetur adipisicing elit. Quasi, tenetur laudantium? Dicta repellendus
                rerum consectetur, voluptatem repudiandae eum ea porro cupiditate provident nulla, deserunt, ab ipsum
                corporis laboriosam deleniti molestias?
              </div> -->
              <span class="room__topics">{{room.topic}}</span>
            </div>
            <div class="room__conversation">
              <div class="threads scroll">
                {% for message in roomMessages %}
                <div class="thread">
                  <div class="thread__top">
                    <div class="thread__author">
                      <a href="{% url 'user-profile' message.user.id %}" class="thread__authorInfo">
                        <div class="avatar avatar--small" data-user-id="{{ message.user.id }}">
                          {% if message.user.profile.profile_img %}
                            <img src="{{ message.user.profile.profile_img.url }}" alt="Profile" />
                          {% else %}
                            <img src="{% static 'images/avatar.svg' %}" alt="Profile" />
                          {% endif %}
                        </div>
                        <span>@{{message.user.username}}</span>
                      </a>
                      <span class="thread__date">{{message.created|timesince}}</span>
                    </div>
                    {% if request.user == message.user %}
                    <a href="{% url 'delete-message' message.id %}">
                      <div class="thread__delete">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                          <title>remove</title>
                          <path
                            d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z"
                          ></path>
                        </svg>
                      </div>
                    </a>
                    {% endif %}
                  </div>
                  <div class="thread__details">
                    {{message.body}}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          {% if request.user.is_authenticated %}
          <div class="room__message">
            <form action="" method="POST">
              {% csrf_token %}
              <input type="text" name="body" placeholder="Write your message here..." />
            </form>
          </div>
          {% endif %}
        </div>
        <!-- Room End -->

        <!--   Start -->
        <div class="participants">
          <h3 class="participants__top">Participants <span>({{participants.count}} Joined)</span></h3>
          <div class="participants__list scroll">
            {% for user in participants %}
            <a href="{% url 'user-profile' user.id %}" class="participant">
              <div class="avatar avatar--medium"  data-user-id="{{ user.id }}">
                {% if user.profile.profile_img %}
                  <img src="{{ user.profile.profile_img.url }}" alt="Profile" />
                {% else %}
                  <img src="{% static 'images/avatar.svg' %}" alt="Profile" />
                {% endif %}
              </div>
              <p>
                {{user.username}}
                <span>@{{user.username}}</span>
              </p>
            </a>
            {% endfor %}
          </div>
        </div>
        <!--  End -->
      </div>
    </main>
<script>
(function () {
  const roomId = "{{ room.id }}";
  const protocol = location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${protocol}://${location.host}/ws/rooms/${roomId}/`);

  setInterval(() => {
    if (socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: "ping" }));
    }
  }, 30000);

  window.addEventListener("beforeunload", () => {
    try { socket.send(JSON.stringify({ type: "bye" })); } catch {}
  });


  // pagination state (server rendered newest 10 first)
  let offset = parseInt("{{ initial_loaded|default:10 }}", 10);
  const limit = parseInt("{{ page_size|default:10 }}", 10);
  let currentPresenceIds = new Set();

  const threads = document.querySelector(".threads");

  function addMessageNewest(m) {
    // used for live messages (newest), prepends to the top
    const div = document.createElement("div");
    div.className = "thread";
    div.innerHTML = `
      <div class="thread__top">
        <div class="thread__author">
          <a href="/profile/${m.user}/" class="thread__authorInfo">
            <div class="avatar avatar--small" data-user-id="${m.user}">
              ${m.profile_img
                ? `<img src="${m.profile_img}" alt="Profile"/>`
                : `<img src="{% static 'images/avatar.svg' %}" alt="Profile"/>`}
            </div>
            <span>@${m.username}</span>
          </a>
          <span class="thread__date">just now</span>
        </div>
      </div>
      <div class="thread__details"></div>`;
    div.querySelector(".thread__details").textContent = m.body;
    threads.prepend(div);
  }

  function messageHtml(m) {
    return `
      <div class="thread">
        <div class="thread__top">
          <div class="thread__author">
            <a href="/profile/${m.user}/" class="thread__authorInfo">
              <div class="avatar avatar--small" data-user-id="${m.user}">
                ${m.profile_img
                  ? `<img src="${m.profile_img}" alt="Profile"/>`
                  : `<img src="{% static 'images/avatar.svg' %}" alt="Profile"/>`}
              </div>
              <span>@${m.username}</span>
            </a>
            <span class="thread__date">${new Date(m.created).toLocaleString()}</span>
          </div>
        </div>
        <div class="thread__details"></div>
      </div>`;
  }

  function appendOlder(messages) {
    // API returns newest-first; when appending older history we want
    // oldest of the batch to appear last, so loop in reverse
    for (let i = messages.length - 1; i >= 0; i--) {
      const m = messages[i];
      const wrap = document.createElement("div");
      wrap.innerHTML = messageHtml(m);
      wrap.querySelector(".thread__details").textContent = m.body;
      threads.appendChild(wrap.firstElementChild);
    }
    // re-apply presence so appended avatars get green dots
    applyPresence(currentPresenceIds);
  }

  async function fetchOlder() {
    try {
      const url = `/rooms/${roomId}/messages.json?offset=${offset}&limit=${limit}`;
      const res = await fetch(url, { credentials: "same-origin" });
      if (!res.ok) return;
      const data = await res.json();
      if (Array.isArray(data.messages) && data.messages.length) {
        appendOlder(data.messages);
        offset += data.messages.length;
        if (data.has_more) {
          // pace the background loads a bit
          setTimeout(fetchOlder, 250);
        }
      }
    } catch (err) {
      // silent fail is fine for background loading
    }
  }

  function applyPresence(userIdsSet) {
    document.querySelectorAll('.avatar[data-user-id]').forEach(el => {
      const uid = Number(el.getAttribute('data-user-id'));
      if (userIdsSet.has(uid)) {
        el.classList.add('active');   // green dot (your CSS handles it)
      } else {
        el.classList.remove('active'); // gray dot
      }
    });
  }

  // websocket events
  socket.addEventListener('message', (e) => {
    const data = JSON.parse(e.data);

    if (data.type === 'presence') {
      currentPresenceIds = new Set(data.users.map(u => u.id));
      applyPresence(currentPresenceIds);
      return;
    }

    if (data.type === 'chat') {
      addMessageNewest(data.message);
      applyPresence(currentPresenceIds); // ensure dot on the newly inserted avatar
      return;
    }
  });

  // send chat
  const form = document.querySelector('.room__message form');
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const input = form.querySelector('input[name="body"]');
      const body = (input.value || "").trim();
      if (!body || socket.readyState !== WebSocket.OPEN) return;
      socket.send(JSON.stringify({ body }));
      input.value = "";
    });
  }

  // kick off background loading of older history
  fetchOlder();
})();
</script>
{% endblock content %}